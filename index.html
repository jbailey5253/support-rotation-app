<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CC Transfer Rotation</title>
  <style>
    :root {
      --bg-color: #f3f4f6;
      --text-color: #1f2937;
      --card-bg: #ffffff;
      --hover-bg: #f3f4f6;
      --muted: #9ca3af;
      --heading-color: #111827;
      --highlight-border: #10b981;
      --highlight-bg: #d1fae5;
    }

    body.dark {
      --bg-color: #1f2937;
      --text-color: #f3f4f6;
      --card-bg: #374151;
      --hover-bg: #4b5563;
      --muted: #9ca3af;
      --heading-color: #ffffff;
      --highlight-border: #34d399;
      --highlight-bg: #065f46;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }

    #username-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #username-modal-inner {
      background-color: var(--card-bg);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      text-align: center;
      max-width: 300px;
    }

    #username-modal input {
      padding: 10px;
      width: 100%;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 12px;
    }

    #username-modal button {
      padding: 10px 20px;
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 900px;
      margin: 0 auto 20px;
    }

    h1 {
      color: var(--heading-color);
      flex: 1;
      text-align: center;
      margin: 0;
    }

    .theme-toggle {
      background-color: #6b7280;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      position: absolute;
      right: 20px;
    }

    .teams {
      display: flex;
      justify-content: center;
      gap: 40px;
      flex-wrap: wrap;
      margin-top: 30px;
    }

    .team {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      width: 280px;
      transition: background-color 0.3s;
    }

    .team h2 {
      text-align: center;
      color: #2563eb;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
    }

    li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 8px;
      margin-bottom: 8px;
      border-radius: 6px;
      background-color: var(--hover-bg);
      transition: all 0.3s ease;
    }

    li.unavailable {
      color: var(--muted);
      text-decoration: line-through;
    }

    li.highlight {
      border: 2px solid var(--highlight-border);
      background-color: var(--highlight-bg);
      font-weight: bold;
      transform: scale(1.02);
    }

    li.faded {
      opacity: 0.5;
    }

    button {
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .assign-button {
      background-color: #2563eb;
      color: white;
      margin-top: 10px;
    }

    .assign-button:hover {
      background-color: #1d4ed8;
    }

    .available {
      background-color: #10b981;
      color: white;
    }

    .available:hover {
      background-color: #059669;
    }

    .unavailable-btn {
      background-color: #ef4444;
      color: white;
    }

    .unavailable-btn:hover {
      background-color: #dc2626;
    }

    #assignment {
      text-align: center;
      font-weight: 500;
      margin-top: 30px;
      font-size: 16px;
    }

    #history-log {
      max-width: 900px;
      margin: 30px auto;
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }

    #history-log h2 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      margin-bottom: 10px;
    }

    #history-list.collapsed {
      display: none;
    }

    @media (max-width: 640px) {
      .teams {
        flex-direction: column;
        align-items: center;
      }

      .team {
        width: 90%;
      }

      .theme-toggle {
        position: static;
        margin-left: 10px;
      }
    }
  </style>
</head>
<body>
  <div id="username-modal">
    <div id="username-modal-inner">
      <h3>Please enter your display name</h3>
      <input type="text" id="username-input" placeholder="Your name">
      <button onclick="saveUsername()">Continue</button>
    </div>
  </div>

  <header>
    <h1>CC Transfer Rotation</h1>
    <button class="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>
  </header>

  <div class="teams">
    <div class="team" id="teamA">
      <h2>DEMS</h2>
      <ul id="listA"></ul>
      <button class="assign-button" onclick="assignNext('A')">Assign Next</button>
    </div>
    <div class="team" id="teamB">
      <h2>Aware</h2>
      <ul id="listB"></ul>
      <button class="assign-button" onclick="assignNext('B')">Assign Next</button>
    </div>
  </div>
  <p id="assignment"></p>

  <div id="history-log">
    <h2 onclick="toggleHistory()">Change History &#x25BC;</h2>
    <ul id="history-list"></ul>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBI1IvsSOGRXss0dTceJQDnkoXfFdhkinc",
      authDomain: "support-rotation-app.firebaseapp.com",
      databaseURL: "https://support-rotation-app-default-rtdb.firebaseio.com/",
      projectId: "support-rotation-app",
      storageBucket: "support-rotation-app.firebasestorage.app",
      messagingSenderId: "559311225453",
      appId: "1:559311225453:web:15e121172a5a042ea8b564",
      measurementId: "G-DR1V84QY22"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let teams = {};

    db.ref('teams').on('value', snapshot => {
      if (snapshot.exists()) {
        teams = snapshot.val();
        render('A');
        render('B');
      }
    });

    function render(teamKey) {
      const team = teams[teamKey];
      const list = document.getElementById(teamKey === 'A' ? 'listA' : 'listB');
      list.innerHTML = '';

      const nextAvailableIndex = team.findIndex(p => p.available);

      team.forEach((person, index) => {
        const li = document.createElement('li');
        li.className = person.available ? '' : 'unavailable';
        if (index === nextAvailableIndex && person.available) li.classList.add('highlight');
        else if (index !== nextAvailableIndex) li.classList.add('faded');

        li.innerHTML = `
          ${person.name}
          <button class="${person.available ? 'available' : 'unavailable-btn'}" onclick="toggleAvailability('${teamKey}', ${index})">
            ${person.available ? 'Available' : 'Unavailable'}
          </button>`;

        list.appendChild(li);
      });
    }

    function toggleAvailability(teamKey, index) {
      const name = teams[teamKey][index].name;
      const newStatus = !teams[teamKey][index].available;
      teams[teamKey][index].available = newStatus;
      db.ref('teams').set(teams);
      logChange(`${name} marked as ${newStatus ? 'Available' : 'Unavailable'} on ${teamKey}`);
    }

    function assignNext(teamKey) {
      const team = teams[teamKey];
      if (team[0].available) {
        const person = team.shift();
        team.push(person);
        showAssignment(`${person.name} is assigned the ticket.`);
        logChange(`${person.name} assigned a ticket on ${teamKey}`);
      } else {
        const idx = team.findIndex((p, i) => i > 0 && p.available);
        if (idx !== -1) {
          const assigned = team.splice(idx, 1)[0];
          team.push(assigned);
          showAssignment(`${assigned.name} is assigned the ticket (top unavailable).`);
          logChange(`${assigned.name} assigned a ticket from ${teamKey} (top unavailable)`);
        } else {
          showAssignment("No available team members.");
        }
      }
      db.ref('teams').set(teams);
    }

    function showAssignment(msg) {
      document.getElementById('assignment').innerText = msg;
    }

    function toggleTheme() {
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    }

    function loadTheme() {
      const saved = localStorage.getItem('theme');
      if (saved === 'dark') document.body.classList.add('dark');
    }

    function getDisplayName() {
      return localStorage.getItem('username') || 'Unknown';
    }

    function saveUsername() {
      const input = document.getElementById('username-input').value.trim();
      if (input.length > 0) {
        localStorage.setItem('username', input);
        document.getElementById('username-modal').style.display = 'none';
      }
    }

    function logChange(action) {
      const time = new Date().toLocaleString();
      const user = getDisplayName();
      const entry = `${time} - ${user}: ${action}`;
      const li = document.createElement('li');
      li.innerText = entry;
      const list = document.getElementById('history-list');
      list.prepend(li);
      while (list.children.length > 10) list.removeChild(list.lastChild);
    }

    function toggleHistory() {
      const list = document.getElementById('history-list');
      list.classList.toggle('collapsed');
    }

    window.onload = () => {
      loadTheme();
      if (!localStorage.getItem('username')) {
        document.getElementById('username-modal').style.display = 'flex';
      } else {
        document.getElementById('username-modal').style.display = 'none';
      }
    }
  </script>
</body>
</html>
